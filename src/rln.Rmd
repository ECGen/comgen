---
title: "Rock Lichen data from Sunset Crater collected by Rikke Naesborg and Richard Michalet"
author: Rikke, Matt, Cameron, Richard
output: pdf_document

---

# Analysis Summary

- Dead trees and non-lichen species were removed from lichen community
  analyses. 
- Lichen communities were adequately sampled, based on species
  accumulation curves, with moth resistant trees accumulating slightly
  more lichen species.
- Lichen communities (abundance, richness, diversity, composition)
were significantly, generally negatively, affected by moth
susceptibility.
- Several tree variables, including light availability, leaf litter
  abundance and rock abundance, were impacted by moth susceptibility.
- Analysis of causal pathways supported an indirect link between moth
  susceptibility and impacts on lichen communities via decreasing rock
  (i.e. habitat) availability through increased leaf abscission and
  accumulation on rocks under trees.
- These results support a genetically based link between intraspecific
  variation in susceptibility to an insect herbivore and community
  dynamics in an arid ecosystem.
- Given the possible impacts of cliimate change on this system, this
  study supports the conclusion that community and ecosystem impacts
  need to be considered in an evolutionary context.

```{r, echo = TRUE, results = "hide", eval = TRUE}
# 0. Supporting functions and libraries
## Support functions

dif <- function(x){
    out=x[1]
    for (i in 2:length(x)){
        out=out-x[i]
    }
    return(out)
}

## Libraries
my.libs <- c("vegan", "ecodist")
if (any(!(my.libs %in% installed.packages()[, 1]))){
    sapply(my.libs[!(my.libs %in% installed.packages()[, 1])], 
           install.packages)
}else{}
sapply(my.libs, require, character.only = TRUE)


```

# Load Data


The following are variable descriptions (Variable, Type, Range, Definition):

    

- Moth,categorical,0 or 1,Was the tree susceptible (0) or resistant (1) to moth attack?
- Live/Dead,categorical,0 or 1,Was the tree dead (0) or alive (1)?
- Litter %,continuous,0 to 100,Percent cover inside quadrat
- Rocks > 3cm? %,continuous,0 to 100,Percent cover of rocks > 3cm? inside quadrat
- Rocks < 3cm? %,continuous,0 to 100,Percent cover of rocks < 3cm? inside quadrat
- Shrubs %,continuous,0 to 100,Percent cover of shrubs inside quadrat
- Grass %,continuous,0 to 100,Percent cover of grass inside quadrat
- Branches %,continuous,0 to 100,Percent cover of branches on ground inside quadrat
- Distance,continuous,0 to 100,"Distance from main trunk, converted to percent of crown radius at that azimuth"
- Azimuth,continuous,0 to 360,Compass direction from main trunk
- Slope,continuous,0 to 90,Topographical steepness
- Aspect,continuous,0 to 360,Compass direction of slope
- Light,continuous,,Amount of light available to epiliths

```{r results = "hide"}

## Data are in ../data/scrl
l.dat <- read.csv("../data/scrl/sp & env combined.csv")

## Summary of data
summary(l.dat)

## remove dead trees
l.dat <- l.dat[l.dat[, "Live.Dead"] != 0, ]

## Lichen species list
spp.l <- c("Acacon", "Acasup", "Acaobp", "Sterile.sp", "Brown.cr",
"Lobalp", "Canros", "Calare", "Phydub", "Rhichr", "Xanlin", "Xanpli",
"Xanele", "GrBr.cr", "Gray.cr")
spp.moss <- c("Synrur", "Cerpur.Bryarg")

## Create a community matrix
com <- l.dat[, colnames(l.dat) %in% spp.l]
com.moss <- l.dat[, colnames(l.dat) %in% spp.moss]

## Add the tree labels to the rownames
rownames(com) <- paste(l.dat[, "Moth"], l.dat[, "Tree.pairs"], sep = "_")
rownames(com.moss) <- paste(l.dat[, "Moth"], l.dat[, "Tree.pairs"], sep = "_")
rownames(l.dat) <- paste(l.dat[, "Moth"], l.dat[, "Tree.pairs"], sep = "_")

```


# Species accumulation

Are the communities on each tree type adequately sampled?

```{r }

spa.all <- specaccum(com)
spa.res <- specaccum(com[l.dat[, "Moth"] == 0, ])
spa.sus <- specaccum(com[l.dat[, "Moth"] == 1, ])

plot(spa.all,
     ylim = c(0, 20),
     xlab = "Cumulative Trees Sampled",
     ylab = "Lichen Species Observed")
lines(spa.res$sites, spa.res$richness, 
      ylim = c(0, 20), lty = 2, lwd = 3)
lines(spa.sus$sites, spa.sus$richness, 
      ylim = c(0, 20), lty = 3, lwd = 3)
legend("bottomright", 
       legend = c("All", "Resistant", "Susceptible"), 
       lty = c(1, 2, 3), lwd = c(1, 2, 2))

```

## Community Analyses 

The following is an analysis of the univariate community metrics,
abundance, richness and diversity (Shannon's index). These three
metrics were strongly intercorrelated and all responded to the
environmental effects of moth infection. Litter cover, light and rock
abundance were all also responsive to moth infection. Other variables,
such as branches, grasses and mosses were not impacted by
moth. Differences are analyzed with univariate t-tests in order to
account for the paired structure of the data. Also presented here are
Shapiro-Wilks tests for homogeneity of variance, which as assumption
of the t-test. These effects should be shown using dotplots with mean
differences as dots and confidence intervals as horizontal lines.



```{r }

## Calculate metrics
abun <- apply(com, 1, sum)
rich <- apply(com, 1, function(x) sum(sign(x)))
shan <- apply(com, 1, diversity, index = "shannon")
## Examine intercorrelations
cor.test(abun, rich, method = "k")
cor.test(abun, shan, method = "k")
cor.test(rich, shan, method = "k")
## Test for moth effects via a one-way test on the
## differences between susceptible and resistance trees.
## diff = Susceptible - Resistant
## If diff is less than 0, susceptibility had a negative effect
## If diff is greater than 0, susceptibility had a positive effect

### Test for violation of normality of differences
shapiro.test(tapply(abun , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(rich , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(shan , l.dat[, "Tree.pairs"], diff))

shapiro.test(tapply(l.dat[, "Litter.."] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Light...N"] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Light...S"] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff))

### Too small for habitat
shapiro.test(tapply(l.dat[, "Small.rocks.."] , l.dat[, "Tree.pairs"], diff))

### Too few observations
shapiro.test(tapply(l.dat[, "Synrur"] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Branches.."] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Grass.."] , l.dat[, "Tree.pairs"], diff))
shapiro.test(tapply(l.dat[, "Cerpur.Bryarg"] , l.dat[, "Tree.pairs"], diff))

### Test for effect of moth
t.test(tapply(abun, l.dat[, "Tree.pairs"], diff))
t.test(tapply(rich, l.dat[, "Tree.pairs"], diff))
t.test(tapply(shan, l.dat[, "Tree.pairs"], diff))

t.test(tapply(l.dat[, "Litter.."] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Light...N"] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Light...S"] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff))
                                        # Ignore these results
t.test(tapply(l.dat[, "Small.rocks.."] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Branches.."] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Grass.."] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Synrur"] , l.dat[, "Tree.pairs"], diff))
t.test(tapply(l.dat[, "Cerpur.Bryarg"] , l.dat[, "Tree.pairs"], diff))


```

<!-- Here are dotplots to visualize the differences. -->

<!-- ```{r } -->

<!-- ### Test for effect of moth -->


<!-- t.test(tapply(abun, l.dat[, "Tree.pairs"], diff)) -->
<!-- t.test(tapply(rich, l.dat[, "Tree.pairs"], diff)) -->
<!-- t.test(tapply(shan, l.dat[, "Tree.pairs"], diff)) -->

<!-- t.test(tapply(l.dat[, "Litter.."] , l.dat[, "Tree.pairs"], diff)) -->
<!-- t.test(tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff)) -->
<!-- t.test(tapply(l.dat[, "Light...N"] , l.dat[, "Tree.pairs"], diff)) -->
<!-- t.test(tapply(l.dat[, "Light...S"] , l.dat[, "Tree.pairs"], diff)) -->
<!-- t.test(tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff)) -->


<!-- ``` -->


Lichen communities as a whole responded to the effects of moth
infection. Using PerMANOVA, a permutational analysis of variance, with
the tree pairs as blocks in the model, we observed a significant
effect of moth susceptibility on lichen community composition. This
should be shown using an NMDS ordination plot.


```{r }
### Composition analysis
com.ds <- cbind(com, ds = rep(0.01, nrow(com)))
adonis2(com.ds ~ Moth, data = l.dat, strata = factor(l.dat$Tree.pairs), perm = 9999)

```

## Indicator species 

Although susceptibility to moth infection generally had a negative
impact on lichen, several species showed significant responses. Here,
because of the paired design, we analyze the response of the
differences using a one-way t-test on the differences of each
species. I don't think we need to plot this, but perhaps the results
could be shown as a table. 

```{r }

ind.spp <- list()
ind.spp$p.value[1] <- t.test(tapply(com[, "Acacon"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[2] <- t.test(tapply(com[, "Acasup"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[3] <- t.test(tapply(com[, "Canros"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[4] <- t.test(tapply(com[, "Lobalp"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[5] <- t.test(tapply(com[, "Phydub"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[6] <- t.test(tapply(com[, "Acaobp"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[7] <- t.test(tapply(com[, "Sterile.sp"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[8] <- t.test(tapply(com[, "Calare"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[9] <- t.test(tapply(com[, "Rhichr"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[10] <- t.test(tapply(com[, "Xanlin"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[11] <- t.test(tapply(com[, "Xanpli"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[12] <- t.test(tapply(com[, "Xanele"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$p.value[13] <- t.test(tapply(com[, "GrBr.cr"], l.dat[, "Tree.pairs"], diff))$p.value
ind.spp$t[1] <- t.test(tapply(com[, "Acacon"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[2] <- t.test(tapply(com[, "Acasup"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[3] <- t.test(tapply(com[, "Canros"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[4] <- t.test(tapply(com[, "Lobalp"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[5] <- t.test(tapply(com[, "Phydub"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[6] <- t.test(tapply(com[, "Acaobp"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[7] <- t.test(tapply(com[, "Sterile.sp"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[8] <- t.test(tapply(com[, "Calare"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[9] <- t.test(tapply(com[, "Rhichr"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[10] <- t.test(tapply(com[, "Xanlin"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[11] <- t.test(tapply(com[, "Xanpli"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[12] <- t.test(tapply(com[, "Xanele"], l.dat[, "Tree.pairs"], diff))$statistic
ind.spp$t[13] <- t.test(tapply(com[, "GrBr.cr"], l.dat[, "Tree.pairs"], diff))$statistic
## This species had zero abundance, perhaps it was only observed under dead trees
t.test(tapply(com[, "Brown.cr"], l.dat[, "Tree.pairs"], diff))
## Assign names to vectors
names(ind.spp$p.value) <- c("Acacon", "Acasup", "Canros", "Lobalp", "Phydub",
"Acaobp", "Sterile.sp", "Calare", "Rhichr", "Xanlin", "Xanpli",
"Xanele", "GrBr.cr")
names(ind.spp$t) <- c("Acacon", "Acasup", "Canros", "Lobalp", "Phydub",
"Acaobp", "Sterile.sp", "Calare", "Rhichr", "Xanlin", "Xanpli",
"Xanele", "GrBr.cr")
ind.spp$p.value <- p.adjust(ind.spp$p.value, method = "fdr")
do.call(cbind, ind.spp)


```


## Exploring causal pathways

I suggest that we develop these into a structural equation
model. Here, I've analyzed several "causal pathways" in parts using
correlation tests of the differences (susceptible - resistant) for
each variable. Here are two hypothesized causal pathways, where lichen
refers to the lichen community abundance, richness, diversity and
composition:

- moth decreases light which decreases lichen
- moth increases litter which covers/decreases rocks which
  support/increase lichen

Only the litter pathway is supported. Although light is impacted by
moth susceptibility, it isn't correlated with lichen. Litter, however,
is positively affected by the moth infection. In addition, litter is
negatively correlated with rock abundance and rock abundance is
positively correlated with lichen. This is also supported by the
indirect pathway between moth and lichen, which are negatively
correlated, as would be expected by the product of the signs along the
pathway (i.e. positive * negative * positive = negative). 



```{r }

### Test for correlations among effects
cor.test(tapply(l.dat[, "Light...average"], l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(l.dat[, "Litter.."], l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff), method = "k")

## Abun
cor.test(tapply(abun, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(abun, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Litter.."] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(abun, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff), method = "k")

## rich
cor.test(tapply(rich, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(rich, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Litter.."] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(rich, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff), method = "k")

## shan
cor.test(tapply(shan, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Light...average"] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(shan, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Litter.."] , l.dat[, "Tree.pairs"], diff), method = "k")
cor.test(tapply(shan, l.dat[, "Tree.pairs"], diff), 
        tapply(l.dat[, "Big.rocks.."] , l.dat[, "Tree.pairs"], diff), method = "k")


```



```{r eval = FALSE, echo = FALSE}

#Distributions of Predictors
source('/Users/artemis/Documents/R_Docs/Scripts/Functions/pairs.R')
pairs(env,lower.panel=panel.cor)
pairs(env,lower.panel=panel.hist)



#Abundance, richness and evenness
#The difference is Resistant - Susceptible
a=apply(com,1,sum)
r=com
r[r!=0]<-1
r=apply(r,1,sum)
h=diversity(com)
ap=tapply(a,tp,dif)
rp=tapply(r,tp,dif)
hp=tapply(h,tp,dif)

wilcox.test(a,y=Tree.pairs,alternative='less',paired=TRUE)
wilcox.test(r,y=Tree.pairs,alternative='less',paired=TRUE)
wilcox.test(h,y=Tree.pairs,alternative='less',paired=TRUE)

par(mfrow=c(1,3))
plot(density(a[tree==0]),main='')
lines(density(a[tree==1]),col='red')
legend('topright',c('Sus','Res'),lty=c(1,1),bty='n',col=c(1,2))

plot(density(r[tree==0]),main='')
lines(density(r[tree==1]),col='red')
legend('topright',c('Sus','Res'),lty=c(1,1),bty='n',col=c(1,2))
plot(density(h[tree==1]),col='red',main='')
lines(density(h[tree==0]))
legend('topright',c('Sus','Res'),lty=c(1,1),bty='n',col=c(1,2))

boxplot(a~tree,outline=FALSE,xlab='Resistance',ylab='Abundance')
boxplot(r~tree,outline=FALSE,xlab='Resistance',ylab='Richness')
boxplot(h~tree,outline=FALSE,xlab='Resistance',ylab='Shannon Index')

se=function(x){sd(x)/sqrt(length(x))}

library(gplots)
par(mfrow=c(1,3))
barplot2(tapply(a,tree,mean),xlab='Resistance',ylab='Percent Abundance',plot.ci=TRUE,ci.u=tapply(a,tree,mean)+tapply(a,tree,se),ci.l=tapply(a,tree,mean)-tapply(a,tree,se))
barplot2(tapply(r,tree,mean),xlab='Resistance',ylab='Species Richness',plot.ci=TRUE,ci.u=tapply(r,tree,mean)+tapply(r,tree,se),ci.l=tapply(r,tree,mean)-tapply(r,tree,se))
barplot2(tapply(h,tree,mean),xlab='Resistance',ylab='Shannon Index',plot.ci=TRUE,ci.u=tapply(h,tree,mean)+tapply(h,tree,se),ci.l=tapply(h,tree,mean)-tapply(h,tree,se))

#Multivariate Community Analyses
pairs(com[apply(com,2,sum)>=5],lower.panel=panel.cor,upper.panel=panel.lmr)
#Composition
d=vegdist(cbind(com,rep(0.01,nrow(com))))
adonis(d~Moth+Tree.pairs/Moth,permutations=99999)

#adonis(d~tree,nperm=5000) without pairs

#mrpp(d,tree,strata=Tree.pairs)

#indicator species analysis
library(labdsv)

indsp=indval(com,(tree+1))
summary(indsp)

detach(package:labdsv)

#community ordination
x=com
x=cbind(x,rep(1,nrow(com)))
dx=vegdist(x)
#nms.x=nmds(dx,1,5)
#plot(nms.x$stress)
#nms.x=nmds(dx,2,2,nits=50)
#nms.x=nmds.min(nms.x,2)
#setwd('/Users/artemis/Documents/Active_Projects/Sunset_Crater_Lichens/SCRL_tex/')
#write.csv(nms.x,'moth_nms.csv',row.names=FALSE)

#Save ordination
setwd('/Users/artemis/Documents/Active_Projects/Sunset_Crater_Lichens/SCRL_tex/')
nms.x=read.csv('moth_nms.csv')
plot(nms.x,col=(env$Moth+1))
fit=envfit(nms.x,env[,c(-9,-10)],permutations=99999)
plot.envfit(fit,col='black')
fit


#Exploring the factors behind the effect of resistance on lichen communities
#Moth and Factors
pairs(cbind(Moth,Litter..,Big.rocks..,Small.rocks..,Light...average),lower.panel=panel.cor,upper.panel=panel.lmr)
cor.test(Litter..,Moth)
cor.test(Big.rocks..,Moth)
cor.test(Small.rocks..,Moth)
cor.test(Light...average,Moth)

#Multiple regression

hist(residuals(lm(a~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
log.a=log(a+0.0000001)
hist(residuals(lm(log.a~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
sqrt.a=sqrt(a)
hist(residuals(lm(sqrt.a~Moth+Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))

summary(lm(sqrt.a~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth))

hist(residuals(lm(r~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
hist(residuals(lm(sqrt(r)~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
hist(residuals(lm(r^2~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))

summary(lm(r^2~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth))

hist(residuals(lm(h~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
hist(residuals(lm(h^2~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
hist(residuals(lm(sqrt(h)~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))
hist(residuals(lm(log(h+0.0000001)~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth)))

summary(lm(h^2~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth))

#Vector Analyses
x=env[,c(-1:-3,-10,-11)]
pairs(x)
dx=vegdist(x)
dx=vegdist(x)
#nms.x=nmds(dx,1,5,nits=10)
#plot(nms.x$stress,type='l')
nms.x=nmds(dx,2,2,nits=100)
nms.x=nmds.min(nms.x,2)
plot(nms.x,col=(env$Moth+1),main='Ordination of Tree via Environmental Parameter')
vec.x=envfit(nms.x,x)
plot(vec.x)
legend('topright',c('S','R'),pch=c(1,1),col=c(1,2))

#PerMANOVA
adonis(d~Litter..+Big.rocks..+Small.rocks..+Light...average+Moth,permutations=9999)


#SEM preliminaries
#correlation structure with abundance, richness and shannon's index
source('/Users/artemis/Documents/R_Docs/Scripts/Functions/pairs.R')
x=cbind(env,a,r,h)
x=x[,c(-1)]
pairs(x,upper.panel=panel.cor,lower.panel=panel.lmr)

x=cbind(env,a)
x=x[,c(-2,-3)]
pairs(x,upper.panel=panel.cor,lower.panel=panel.lmr)

pairs(cbind(a,Litter..,Big.rocks..,Small.rocks..))
plot(Moth,Litter..)

#Write to file for input to AMOS
#SCRL=lichen[[3]]
#SCRL=cbind(SCRL,a,r,h)
#colnames(SCRL)[1:12]=c('pairs','resistance','living','litter','big.rocks','small.rocks','shrubs','grass','branches','light.N','light.S','light.avg')
#summary(SCRL)
#write.csv(SCRL,'SCRL')

#Communities
#com.p=array(NA,c(length(unique(tp)),ncol(com)))
#colnames(com.p)<-colnames(com)
#
#for (i in 1:length(unique(tp))){
#	com.p[i,]=as.matrix(com[tp==unique(tp)[i],][1,]-com[tp==unique(tp)[i],][2,])
#	}
#Correlation Graphs
#library(sna)
#lich.cor=cor(com)
#lich.cor[abs(lich.cor)<0.2]=0
#size=apply(com,2,sum)+1
#gplot(abs(lich.cor),gmode='graph',displaylabels=TRUE,vertex.cex=size/5,vertex.sides=100,vertex.border='red',edge.col='darkgrey')

pairs(com[apply(com,2,sum)>=5])

d=vegdist(cbind(com,rep(0.01,nrow(com))))

adonis(d~tree+Tree.pairs/tree,nperm=5000)
#mrpp(d,tree,strata=Tree.pairs)

#indicator species analysis
library(labdsv)

indsp=indval(com,(tree+1))
summary(indsp)

detach(package:labdsv)

#Ordination
scree=nmds(d,1,3,3)$stress
plot(scree)

ord=nmds(d,3,3,nits=10)
ord=nmds.min(ord,3)
plot(ord,col=(tree+1))
ord.fig=ordiplot(ord,c(1,3),type='n')
points(ord.fig,'sites',col=(tree+1))
ordispider(ord.fig,Tree.pairs)
hist(tree[apply(com,1,sum)==0])
Tree.pairs[apply(com,1,sum)==0]

#Remove the zero sums
my.col=c('green','purple')
ord.rzs=ord[apply(com,1,sum)!=0,]
tree.rzs=tree[apply(com,1,sum)!=0]
Tree.pairs.rzs=Tree.pairs[apply(com,1,sum)!=0]
ord.fig=ordiplot(ord.rzs,c(1,2),type='n')
points(ord.fig,'sites',col=my.col[(tree.rzs+1)],pch=15)
ordispider(ord.fig,Tree.pairs.rzs,col='orange',lwd=0.5)

#
#
#setwd('/Users/artemis/Documents/R_Docs/Rikke Naesborg')
#dir()
#setwd('Rikke Data')
#dir()
#rl.c=read.csv('sp & env combined-Table 1.csv')[,-1:-9]#all observations
#rl.e=read.csv('sp & env combined-Table 1.csv')[,1:9]#all observations
##rl.c=read.csv("Rikke.csv")[,-1:-9] #rock lichen community
##rl.e=read.csv("Rikke.csv")[,1:9] #rock lichen environmental data
#
#library(vegan)
#
#names(rl.e)
#attach(rl.e)
#plot(Moth,Rocks.3cm..)
#
##Explore the abundances
#A=apply(rl.c,2,sum) #total species abundances
#barplot(A[order(A,decreasing=TRUE)],name=colnames(rl.c)[order(A,decreasing=TRUE)],las=2)
#
#Ap=apply(rl.c,1,sum) #total abundance per plot
#
#summary(aov(sqrt(Ap)~factor(Moth)+factor(Live.Dead)+(Litter.)+Rocks.3cm..+Rocks.3cm...1))
#hist(aov(sqrt(Ap)~factor(Moth)+factor(Live.Dead)+(Litter.))$residuals)
#
#plot(Litter.~Rocks.3cm..)
#pairs(rl.e)
#
#hist(aov(sqrt(Ap)~factor(Moth))$residuals)
#barplot(c(mean(Ap[Moth==0]),mean(Ap[Moth==1])),names=c('S','R'),ylab='Total Abundance')
#
##richness and diversity
#quartz()
#R=specnumber(rl.c)
#summary(aov(R~factor(Moth)*factor(Live.Dead)*(Litter.)))
#hist(residuals(aov(R~factor(Moth)+factor(Live.Dead)+(Litter.))))
#
#plot(R~Litter.,col=(as.numeric((Moth))+1))
#abline(lm(R[Moth==0]~Litter.[Moth==0]),col=1)
#abline(lm(R[Moth==1]~Litter.[Moth==1]),col=2)
#
#H=diversity(rl.c)
#summary(aov((H)~factor(Moth)*factor(Live.Dead)*(Litter.)))
#hist(residuals(aov((H)~factor(Moth)+factor(Live.Dead)+(Litter.))))
#
#plot(H~Litter.,col=(as.numeric((Moth))+1))
#abline(lm(H[Moth==0]~Litter.[Moth==0]),col=1)
#abline(lm(H[Moth==1]~Litter.[Moth==1]),col=2)
#
##Removing rare species
#rl.c=rl.c[,A>=5]
#names(rl.c)
#
##check for zero sum rows
#if (any(apply(rl.c,1,sum)==0)){
#dummy=rep(min(rl.c[rl.c!=0]),nrow(rl.c))
#d=vegdist(data.frame(rl.c,dummy))}else{
#d=vegdist(data.frame(rl.c))	
#	}
#
##permanova
#adonis(d~factor(Moth)*factor(Live.Dead)*Litter.)
#
##relativize by species max
##check for zero sum rows
#rl.c.max=decostand(rl.c,2,method='max')
#if (any(apply(rl.c.max,1,sum)==0)){
#dummy=rep(min(rl.c.max[rl.c.max!=0]),nrow(rl.c.max))
#d.max=vegdist(data.frame(rl.c.max,dummy))}else{
#d.max=vegdist(data.frame(rl.c.max))	
#	}
#
##permanova
#adonis(d.max~factor(Moth)*factor(Live.Dead)*Litter.)
#
#library(ecodist)
##n=nmds(vegdist(rl.c),1,5)
##plot(n$stress) 
##three dimensions looks best
#
##ordination
#n=nmds(d,3,3,nits=50)
#plot(n$stress)
#n.=nmds.min(n)
#plot(n.,col=(as.numeric(Moth)+1))
#
#ordiplot(n.,c(1,2),type='none')
#points(n.[,1:2],pch=(as.numeric(Moth)+1))
#ordispider(n.[,1:2],Moth,col=c('violet'))
#plot(envfit(n.~Litter.),add=TRUE)
#
#
##Multivariate Dispersion Test
#b=betadisper(d,Moth,type='centroid')
#permutest.betadisper(b)
#par(mfrow=c(1,2))
#plot(b,main='Dispersion')
#plot(TukeyHSD(b),ylab='')
#
##Indicator Species Analysis
#library(labdsv)
#names(rl.c)
#summary(indval(rl.c,Moth))
#ds=vegdist(t(rl.c))
#plot(hclust(ds))
#
##Cluster diagram of plots with moth overlay
#plot(hclust(d),labels=Moth)
#
#detach(rl.e)
#rm(list=c('d','rl.c','rl.e'))
#
#
##Output to PCORD
##rock.stability=Rocks.3cm../(Rocks.3cm..+Rocks.3cm...1) 
##this index didn't work because sometimes there are only big rocks and no little rocks
##However, in doing this it seems as though using the both factors in the model might be useful
#
#out=cbind(Ap,R,H,rock.stability,rl.e)
#
#write.csv(out,'/Users/artemis/Desktop/rocklichen',row.names=FALSE)
#
####1) Calculate the roack size index (stability index) = A_r>3 / A_rT
####2) Conduct SEM (NOTE! Handle the binary response variables!!!)
#
##Test for the effect of rocks >3cm on moth susceptibility
#rocks.glm=glm(Moth~Rocks.3cm..,family='binomial')
#summary(rocks.glm)
#plot(Moth~Rocks.3cm..)
#points(Rocks.3cm..,fitted(glm(Moth~Rocks.3cm..,family=binomial(link='logit'))),cex=0.5,col='red')
#lines(spline(Rocks.3cm..,fitted(glm(Moth~Rocks.3cm..,family=binomial(link='logit')))),cex=0.5,col='red')
#AIC(glm(Moth~Rocks.3cm..,family=binomial(link='logit')))
#AIC(lm(Moth~Rocks.3cm..))
#points(Rocks.3cm..,fitted(lm(Moth~Rocks.3cm..)),cex=0.5,col='blue')
#lines(Rocks.3cm..,fitted(lm(Moth~Rocks.3cm..)),cex=0.5,col='blue')
#legend('right',legend=c('Linear','Binomial'),bty='n',fill=c('blue','red'),border=c('blue','red'))

#Sweave

setwd('/Users/artemis/Documents/Active_Projects/Sunset_Crater_Lichens/lichen & abiotic cover Sunset Crater paired')

lichen=list()
for (i in 1:length(dir())){
	lichen[[i]]=read.csv(dir()[i])
	}
names(lichen)=dir()
names(lichen)

summary(lichen[[3]])

#remove dead trees
lichen[[3]]=lichen[[3]][lichen[[3]][,3]==1,]
my.wd=getwd()
setwd('/Users/artemis/Documents/Active_Projects/Sunset_Crater_Lichens/SCRL_tex')
Sweave('/Users/artemis/Documents/Active_Projects/Sunset_Crater_Lichens/SCRL_tex/SCRL_tex.Rnw')
Stangle('/Users/artemis/Documents/Active_Projects/Sunset_Crater_Lichens/SCRL_tex/SCRL_tex.Rnw')
setwd(my.wd)

```
